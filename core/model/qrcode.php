<?php

/*
 * 人人商城V2
 * 
 * @author ewei 狸小狐 QQ:22185157 
 */
if (!defined('IN_IA')) {
    exit('Access Denied');
}

class Qrcode_EweiShopV2Model {
  
    /**
     * 商城二维码
     * @global type $_W
     * @param type $mid
     * @return string
     */   
    public function createShopQrcode($mid = 0,$posterid = 0) {
        global $_W,$_GPC;
        $path = IA_ROOT."/addons/ewei_shopv2/data/qrcode/".$_W['uniacid']."/";
        if (!is_dir($path)) {
            load()->func('file');
            mkdirs($path);
        }
        $url = mobileUrl('',array('mid'=>$mid),true);
        if(!empty($posterid)){
            $url.='&posterid='.$posterid;
        }
        $file = 'shop_qrcode_'.$posterid.'_'.$mid. '.png';
        $qrcode_file = $path . $file;
        if (!is_file($qrcode_file)) { 
            require IA_ROOT . '/framework/library/qrcode/phpqrcode.php';
            QRcode::png($url, $qrcode_file, QR_ECLEVEL_L, 4);
        } 
        return  $_W['siteroot'].'addons/ewei_shopv2/data/qrcode/'.$_W['uniacid'].'/'.$file;
    }
    /**
     * 产品二维码
     * @global type $_W
     * @param type $goodsid
     * @return string
     */
    public function createGoodsQrcode($mid = 0 ,$goodsid = 0,$posterid =0) {
        global $_W,$_GPC;
        $path = IA_ROOT."/addons/ewei_shopv2/data/qrcode/".$_W['uniacid'];
        if (!is_dir($path)) {
            load()->func('file');
            mkdirs($path);
        }

        $url = mobileUrl('goods/detail',array('id'=>$goodsid,'mid'=>$mid),true);
        if(!empty($posterid)){
            $url.='&posterid='.$posterid;
        }
        $file = 'goods_qrcode_'.$posterid.'_'.$mid.'_'.$goodsid.'.png';
        $qrcode_file = $path . '/'.$file;
        if (!is_file($qrcode_file)) {
            require IA_ROOT . '/framework/library/qrcode/phpqrcode.php';
            QRcode::png($url, $qrcode_file, QR_ECLEVEL_L, 4);
        } 
        return  $_W['siteroot'].'addons/ewei_shopv2/data/qrcode/'.$_W['uniacid'].'/'.$file;
    }
  
    public function createQrcode($url,$times=0) {
        global $_W,$_GPC;
        $path = IA_ROOT."/addons/ewei_shopv2/data/qrcode/".$_W['uniacid']."/";
        if (!is_dir($path)) {
            load()->func('file');
            mkdirs($path);
        }
        $file = md5( base64_encode($url) ).".jpg";
        $qrcode_file = $path . $file;
        if (!is_file($qrcode_file)) { 
            require IA_ROOT . '/framework/library/qrcode/phpqrcode.php';
            QRcode::png($url, $qrcode_file, QR_ECLEVEL_L, 4);
        } 
        return  $_W['siteroot'].'addons/ewei_shopv2/data/qrcode/'.$_W['uniacid'].'/'.$file;
    }

}
